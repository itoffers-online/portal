#!/usr/bin/env php
<?php

use App\Offers\Command\Email\ScanMessages;
use Ddeboer\Imap\Server;
use HireInSocial\Offers\Application\Config;
use Symfony\Component\Console\Application;
use Symfony\Component\Filesystem\Filesystem;
use function HireInSocial\Offers\Infrastructure\bootstrap;
use function HireInSocial\Offers\Infrastructure\offersFacade;

$projectRootPath = dirname(__DIR__);

require $projectRootPath . '/src/autoload.php';

$config = bootstrap($projectRootPath);
$offers = offersFacade($config);

$serverConfig = $config->getJson(Config::APPLY_EMAIL_CONFIG);

$server = new Server($serverConfig['host'], $serverConfig['port']);
$connection = $server->authenticate($serverConfig['username'], $serverConfig['password']);
$fs = new Filesystem();

(new Application('email-scan', '1.0.0'))
    ->add(new ScanMessages($offers, $connection, $fs))
    ->getApplication()
    ->setDefaultCommand(ScanMessages::NAME, true)
    ->run();