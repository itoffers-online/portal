#!/usr/bin/env php
<?php

use Doctrine\DBAL\Migrations\Configuration\Configuration as MigrationConfiguration;
use Doctrine\DBAL\Migrations\Tools\Console\Command\DiffCommand;
use Doctrine\DBAL\Migrations\Tools\Console\Command\MigrateCommand;
use Doctrine\DBAL\Tools\Console\ConsoleRunner;
use Doctrine\DBAL\Tools\Console\Helper\ConnectionHelper;
use Doctrine\ORM\Tools\Console\Command\ClearCache\MetadataCommand;
use Doctrine\ORM\Tools\Console\Command\ClearCache\QueryCommand;
use Doctrine\ORM\Tools\Console\Command\GenerateProxiesCommand;
use Doctrine\ORM\Tools\Console\Helper\EntityManagerHelper;
use HireInSocial\Offers\Application\System;
use HireInSocial\Offers\Infrastructure\Doctrine\DBAL\Schema\HireInSocialSchemaProvider;
use HireInSocial\Offers\Application\Config;
use Symfony\Component\Console\Helper\HelperSet;
use Symfony\Component\Console\Helper\QuestionHelper;
use function HireInSocial\Offers\Infrastructure\bootstrap;
use function HireInSocial\Offers\Infrastructure\dbal;
use function HireInSocial\Offers\Infrastructure\orm;

$projectRootPath = dirname(__DIR__);

require $projectRootPath . '/src/autoload.php';

$config = bootstrap($projectRootPath);

$connection = dbal($config);
$entityManager = orm($config, $connection);

$migrationsConfig = new MigrationConfiguration($connection);
$migrationsConfig->setMigrationsNamespace(System::class . '\\Doctrine\\DBAL\\Migrations');
$migrationsConfig->setMigrationsTableName('his_db_migration');
$migrationsConfig->setMigrationsDirectory($config->getString(Config::ROOT_PATH) . '/db/migrations');
$migrationsConfig->registerMigrationsFromDirectory($config->getString(Config::ROOT_PATH) . '/db/migrations');
$migrationsConfig->setMigrationsAreOrganizedByYearAndMonth(true);

$migrateCommand = new MigrateCommand();
$migrateCommand->setMigrationConfiguration($migrationsConfig);

$diffCommand = new DiffCommand(
    new HireInSocialSchemaProvider($entityManager)
);
$diffCommand->setMigrationConfiguration($migrationsConfig);

$helperSet = new HelperSet([
    'db' => new ConnectionHelper($connection),
    'em' => new EntityManagerHelper($entityManager),
    'question' => new QuestionHelper(),
]);

ConsoleRunner::run($helperSet, [
    $migrateCommand,
    $diffCommand,
    new GenerateProxiesCommand(),
    new MetadataCommand(),
    new QueryCommand()
]);
